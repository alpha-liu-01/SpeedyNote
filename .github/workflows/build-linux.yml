name: Build SpeedyNote Linux Packages

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  release:
    types: [ created ]

jobs:
  build-deb:
    name: Build DEB Package (Ubuntu/Debian)
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            make \
            pkg-config \
            qt6-base-dev \
            qt6-tools-dev \
            libpoppler-qt6-dev \
            libsdl2-dev \
            libasound2-dev \
            libmupdf-dev \
            libharfbuzz-dev \
            libfreetype-dev \
            libjpeg-dev \
            libopenjp2-7-dev \
            libjbig2dec0-dev \
            libgumbo-dev \
            libmujs-dev \
            dpkg-dev \
            devscripts

      - name: Build and create DEB package
        run: |
          chmod +x ./build-package.sh
          ./build-package.sh --deb

      - name: Upload DEB package
        uses: actions/upload-artifact@v4
        with:
          name: speedynote-deb-amd64
          path: "*.deb"

  build-rpm:
    name: Build RPM Package (Fedora/RHEL)
    runs-on: ubuntu-24.04
    container:
      image: fedora:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            cmake \
            make \
            pkgconf \
            qt6-qtbase-devel \
            qt6-qttools-devel \
            poppler-qt6-devel \
            SDL2-devel \
            alsa-lib-devel \
            mupdf-devel \
            harfbuzz-devel \
            freetype-devel \
            libjpeg-turbo-devel \
            openjpeg2-devel \
            jbig2dec-devel \
            gumbo-parser-devel \
            mujs-devel \
            rpm-build \
            rpm-devel

      - name: Build and create RPM package
        run: |
          chmod +x ./build-package.sh
          ./build-package.sh --rpm

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: speedynote-rpm-x86_64
          path: "*.rpm"

  # Note: ARM64 builds require native ARM64 runners (ubuntu-24.04-arm64)
  # which may not be available on all GitHub plans.
  # Uncomment below when ARM64 runners are available:
  #
  # build-deb-arm64:
  #   name: Build DEB Package (ARM64)
  #   runs-on: ubuntu-24.04-arm64
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Install build dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y cmake make pkg-config qt6-base-dev qt6-tools-dev \
  #           libpoppler-qt6-dev libsdl2-dev libasound2-dev libmupdf-dev \
  #           libharfbuzz-dev libfreetype-dev libjpeg-dev libopenjp2-7-dev \
  #           dpkg-dev devscripts
  #     - name: Build and create DEB package
  #       run: ./build-package.sh --deb
  #     - name: Upload DEB package
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: speedynote-deb-arm64
  #         path: "*.deb"
